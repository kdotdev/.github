name: Dependency Update CI Fix

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to fix"
        required: true
        type: string

permissions:
  checks: read
  contents: write
  id-token: write
  pull-requests: write
  actions: read

concurrency:
  group: dep-update-ci-fix-pr-${{ inputs.pr_number }}
  cancel-in-progress: true

jobs:
  fix:
    runs-on: namespace-profile-ubuntu
    timeout-minutes: 30
    steps:
      - name: Get PR Info
        id: pr-info
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_DATA=$(gh pr view ${{ inputs.pr_number }} \
            --json headRefName,headRefOid,author \
            --repo ${{ github.repository }})
          echo "branch=$(echo "$PR_DATA" | jq -r '.headRefName')" >> "$GITHUB_OUTPUT"
          echo "sha=$(echo "$PR_DATA" | jq -r '.headRefOid')" >> "$GITHUB_OUTPUT"
          AUTHOR=$(echo "$PR_DATA" | jq -r '.author.login')
          echo "author=$AUTHOR" >> "$GITHUB_OUTPUT"
          echo "PR #${{ inputs.pr_number }}: branch=$(echo "$PR_DATA" | jq -r '.headRefName'), author=$AUTHOR"

      - name: Verify Dependency Bot PR
        run: |
          AUTHOR="${{ steps.pr-info.outputs.author }}"
          if [[ "$AUTHOR" != *"renovate"* ]] && [[ "$AUTHOR" != *"dependabot"* ]]; then
            echo "::error::PR #${{ inputs.pr_number }} is not from a dependency bot (author: $AUTHOR)"
            exit 1
          fi

      - uses: actions/checkout@v6
        with:
          ref: ${{ steps.pr-info.outputs.branch }}
          fetch-depth: 0

      - name: Gather CI failure context
        id: ci-context
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_SHA="${{ steps.pr-info.outputs.sha }}"

          FAILED_CHECKS=$(gh api \
            "repos/${{ github.repository }}/commits/${PR_SHA}/check-runs" \
            --jq '[.check_runs[] | select(.conclusion == "failure") | {name: .name, id: .id, html_url: .html_url}]')

          {
            echo "failed_checks<<EOF"
            echo "$FAILED_CHECKS"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Run Claude Code to fix CI
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: '--allowedTools "Bash,Read,Write,Edit,Glob,Grep,WebFetch,WebSearch" --max-turns 50'
          prompt: |
            You are fixing CI failures on a dependency update PR (#${{ inputs.pr_number }}) in this repository.

            ## Failed CI Checks
            ${{ steps.ci-context.outputs.failed_checks }}

            ## Your Task
            1. Read CLAUDE.md (if it exists) in the repository root for project-specific commands and conventions
            2. Identify what CI checks failed and understand the root cause from the dependency update
            3. Run the project's lint, typecheck, and test commands to reproduce failures locally
            4. Fix the issues caused by the dependency update
            5. Verify all checks pass
            6. Commit and push your fixes

            ## Constraints
            - Follow existing code patterns and conventions exactly
            - Only fix what is broken by the dependency update
            - Do NOT add new features or refactor unrelated code
            - Do NOT disable linter rules or type checks to suppress errors
